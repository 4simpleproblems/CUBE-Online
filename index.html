<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cube World Online</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            background-color: #222;
            color: #eee;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            image-rendering: pixelated;
        }

        #game-container {
            border: 4px solid #888;
            background-color: #c2c2c2;
            width: 80vw;
            height: 60vh;
            max-width: 640px;
            max-height: 480px;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .player {
            width: 10px;
            height: 20px;
            position: absolute;
            transition: left 0.1s linear, top 0.1s linear;
        }
        
        .player-head {
            width: 10px;
            height: 10px;
            background-color: #333;
            border-radius: 50%;
            position: absolute;
            top: -5px;
        }

        .player-body {
            width: 2px;
            height: 10px;
            background-color: #333;
            position: absolute;
            top: 5px;
            left: 4px;
        }

        .login-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(0,0,0,0.7);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        
        .hidden {
            display: none !important;
        }

        #login-screen h1 {
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 2px 2px #000;
        }

        .input-field {
            padding: 10px;
            font-family: 'Press Start 2P', cursive;
            border: 2px solid #888;
            background-color: #eee;
            text-align: center;
            border-radius: 4px;
            margin-bottom: 15px;
            width: 80%;
            max-width: 250px;
        }

        .btn {
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            border: 2px solid #888;
            background-color: #5cb85c;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            text-shadow: 1px 1px #000;
            margin: 5px;
        }
        
        .btn:hover {
            background-color: #4cae4c;
        }
        
        .btn-secondary {
            background-color: #f0ad4e;
        }
        .btn-secondary:hover {
            background-color: #ec971f;
        }

        #status {
            margin-top: 20px;
            font-size: 12px;
            text-align: center;
        }
        
        #lobby-code-display {
            font-size: 16px;
            margin-top: 10px;
            padding: 10px;
            background: #333;
            border-radius: 4px;
            border: 2px solid #888;
        }
        
        .player-name {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            color: #333;
            white-space: nowrap;
        }
        
        .message-box-hidden { display: none !important; }
        #message-box {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); display: flex;
            align-items: center; justify-content: center; z-index: 20;
        }
        #message-box-content {
            background-color: #c2c2c2; color: #222; padding: 30px;
            border: 4px solid #888; border-radius: 8px; text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #message-box-ok { margin-top: 20px; }

    </style>
</head>
<body>

    <div id="game-container">
        <!-- Initial Login View -->
        <div id="login-view" class="login-view">
            <h1>Cube World Online</h1>
            <input type="text" id="username" class="input-field" placeholder="Enter Username">
            <button id="create-lobby-btn" class="btn">Create Lobby</button>
            <button id="show-join-view-btn" class="btn btn-secondary">Join Lobby</button>
        </div>
        
        <!-- Join Lobby View -->
        <div id="join-view" class="login-view hidden">
             <h1>Join a Lobby</h1>
             <input type="text" id="username-join" class="input-field" placeholder="Enter Username">
             <input type="text" id="lobby-code-input" class="input-field" placeholder="Enter 8-Digit Code">
             <button id="join-lobby-btn" class="btn">Join</button>
             <button id="back-to-main-btn" class="btn btn-secondary">Back</button>
        </div>
    </div>

    <div id="status"></div>

    <div id="message-box" class="message-box-hidden">
        <div id="message-box-content">
            <p id="message-text"></p>
            <button id="message-box-ok" class="btn">OK</button>
        </div>
    </div>

    <script>
        // --- PeerJS & Game State ---
        let peer;
        let myPeerId;
        let lobbyCode;
        let isHost = false;
        const connections = new Map();
        const players = new Map();
        const LOBBY_PREFIX = 'CUBE-WORLD-';

        // --- UI Elements ---
        const loginView = document.getElementById('login-view');
        const joinView = document.getElementById('join-view');
        const statusDiv = document.getElementById('status');
        
        // --- UI Event Listeners ---
        document.getElementById('create-lobby-btn').addEventListener('click', () => {
            const username = document.getElementById('username').value.trim();
            if (username) {
                isHost = true;
                lobbyCode = generateLobbyCode();
                initializePeer(username, LOBBY_PREFIX + lobbyCode);
            } else {
                showMessage('Please enter a username.');
            }
        });

        document.getElementById('show-join-view-btn').addEventListener('click', () => {
            loginView.classList.add('hidden');
            joinView.classList.remove('hidden');
            // Carry over the username if it was already entered
            document.getElementById('username-join').value = document.getElementById('username').value;
        });

        document.getElementById('join-lobby-btn').addEventListener('click', () => {
            const username = document.getElementById('username-join').value.trim();
            const codeInput = document.getElementById('lobby-code-input').value.trim().toUpperCase();
            if (!username) {
                showMessage('Please enter a username.');
                return;
            }
            if (!codeInput || codeInput.length !== 8) {
                showMessage('Please enter a valid 8-digit lobby code.');
                return;
            }
            isHost = false;
            lobbyCode = codeInput;
            // Clients get a random peer ID so multiple can join the same lobby
            initializePeer(username, null);
        });

        document.getElementById('back-to-main-btn').addEventListener('click', () => {
            joinView.classList.add('hidden');
            loginView.classList.remove('hidden');
        });

        // --- PeerJS Initialization ---
        function initializePeer(username, requestedId) {
            // If no ID is requested (client), PeerJS will generate one.
            // If an ID is requested (host), PeerJS will use that.
            peer = new Peer(requestedId, {});

            peer.on('open', id => {
                myPeerId = id;
                console.log('My peer ID is: ' + id);
                
                // Hide all login views
                loginView.classList.add('hidden');
                joinView.classList.add('hidden');
                
                // Display lobby code
                statusDiv.innerHTML = `Lobby Code: <span id="lobby-code-display">${lobbyCode}</span>`;

                createPlayer(myPeerId, username, { x: Math.random() * 300 + 50, y: Math.random() * 200 + 50 });
                document.addEventListener('keydown', handleKeyPress);

                if (!isHost) {
                    // Client connects to the host
                    connectToPeer(LOBBY_PREFIX + lobbyCode);
                }
            });

            peer.on('connection', conn => {
                console.log('Incoming connection from', conn.peer);
                setupConnection(conn);
            });

            peer.on('error', err => {
                console.error('PeerJS error:', err);
                showMessage(`Connection error: ${err.type}. Could not find lobby or connection failed.`);
                // Reset UI
                joinView.classList.add('hidden');
                loginView.classList.remove('hidden');
            });
        }

        // --- Connection Management & Mesh Networking ---
        function setupConnection(conn) {
            conn.on('open', () => {
                console.log('Connection established with', conn.peer);
                connections.set(conn.peer, conn);

                // --- Host Logic: Welcome new players ---
                if (isHost) {
                    // 1. Send the new player a list of everyone already here.
                    const allPeerIds = [myPeerId, ...Array.from(connections.keys())].filter(p => p !== conn.peer);
                    conn.send({ type: 'lobby-roster', peers: allPeerIds });
                    
                    // 2. Tell everyone else about the new player.
                    broadcast({ type: 'new-peer-announcement', peerId: conn.peer }, conn.peer);
                }
                
                // --- All players: Send their info to the new connection ---
                const myPlayerData = players.get(myPeerId);
                conn.send({
                    type: 'player-update',
                    peerId: myPeerId,
                    username: myPlayerData.username,
                    position: myPlayerData.position
                });
            });

            conn.on('data', data => handleData(data, conn.peer));

            conn.on('close', () => {
                console.log('Connection closed with', conn.peer);
                removePlayer(conn.peer);
                connections.delete(conn.peer);
                broadcast({ type: 'player-leave', peerId: conn.peer });
            });
        }
        
        function connectToPeer(peerId) {
            if (!connections.has(peerId) && peerId !== myPeerId) {
                console.log('Attempting to connect to', peerId);
                const conn = peer.connect(peerId);
                setupConnection(conn);
            }
        }

        // --- Data Handling ---
        function handleData(data, peerId) {
            switch(data.type) {
                case 'player-update':
                    updatePlayer(data.peerId, data);
                    break;
                case 'player-leave':
                    removePlayer(data.peerId);
                    break;
                // --- Client Logic: Connect to other peers in the lobby ---
                case 'lobby-roster':
                    console.log('Received lobby roster:', data.peers);
                    data.peers.forEach(p => connectToPeer(p));
                    break;
                case 'new-peer-announcement':
                    console.log('New peer announced:', data.peerId);
                    connectToPeer(data.peerId);
                    break;
            }
        }

        function broadcast(data, excludePeerId = null) {
            for (const [peerId, conn] of connections.entries()) {
                if (peerId !== excludePeerId) {
                    conn.send(data);
                }
            }
        }

        // --- Game Logic ---
        const gameContainer = document.getElementById('game-container');

        function createPlayer(peerId, username, position) {
            if (document.getElementById(peerId)) return;
            const playerEl = document.createElement('div');
            playerEl.id = peerId;
            playerEl.className = 'player';
            playerEl.innerHTML = `
                <div class="player-head"></div>
                <div class="player-body"></div>
                <div class="player-name">${username}</div>
            `;
            gameContainer.appendChild(playerEl);
            players.set(peerId, { element: playerEl, username: username, position: position });
            updatePlayerElementPosition(peerId);
        }

        function removePlayer(peerId) {
            const playerData = players.get(peerId);
            if (playerData) {
                playerData.element.remove();
                players.delete(peerId);
            }
        }

        function updatePlayer(peerId, data) {
            let playerData = players.get(peerId);
            if (!playerData) {
                console.log("Received update for unknown player, creating them:", data);
                createPlayer(peerId, data.username, data.position);
            } else {
                if (data.position) playerData.position = data.position;
                if (data.username) playerData.username = data.username;
                updatePlayerElementPosition(peerId);
            }
        }
        
        function updatePlayerElementPosition(peerId) {
            const playerData = players.get(peerId);
            if (playerData) {
                playerData.element.style.left = playerData.position.x + 'px';
                playerData.element.style.top = playerData.position.y + 'px';
            }
        }

        // --- User Input ---
        const moveSpeed = 10;
        function handleKeyPress(e) {
            const myPlayerData = players.get(myPeerId);
            if (!myPlayerData) return;
            let moved = false;
            switch(e.key) {
                case 'ArrowUp': case 'w': myPlayerData.position.y -= moveSpeed; moved = true; break;
                case 'ArrowDown': case 's': myPlayerData.position.y += moveSpeed; moved = true; break;
                case 'ArrowLeft': case 'a': myPlayerData.position.x -= moveSpeed; moved = true; break;
                case 'ArrowRight': case 'd': myPlayerData.position.x += moveSpeed; moved = true; break;
            }
            if (moved) {
                const bounds = gameContainer.getBoundingClientRect();
                const playerEl = myPlayerData.element;
                myPlayerData.position.x = Math.max(0, Math.min(bounds.width - playerEl.offsetWidth, myPlayerData.position.x));
                myPlayerData.position.y = Math.max(0, Math.min(bounds.height - playerEl.offsetHeight, myPlayerData.position.y));
                updatePlayerElementPosition(myPeerId);
                broadcast({ type: 'player-update', peerId: myPeerId, position: myPlayerData.position });
            }
        }
        
        // --- UI & Utility Functions ---
        function showMessage(message) {
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-box').classList.remove('message-box-hidden');
        }
        document.getElementById('message-box-ok').addEventListener('click', () => {
            document.getElementById('message-box').classList.add('message-box-hidden');
        });
        
        function generateLobbyCode() {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        }
    </script>
</body>
</html>
